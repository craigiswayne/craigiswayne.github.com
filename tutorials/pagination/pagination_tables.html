<!-- if the results per page does not match the initial set of results per page, make sure they are fetched on load-->
<!-- colspan of the footer must be the max colspan in the table-->

<table class="pagination" data-total_results="27" data-url="/?class=bb_one_promotions&amp;method=get_my_vouchers_table" data-results_p>
	<thead>
		<tr>
			<th>#</th>
			<th>Date Requested</th>
			<th>Partner</th>
			<th>Description</th>
			<th>Voucher Code</th>
			<th>Points Used</th>
			<th>Validity</th>
			<th>Action</th>
		</tr>
	</thead>
	
	<tbody>
		
		<tr data-result_num=1>
			<td>1</td>
			<td>2014-04-25 11:11:56</td>
			<td>Basma Rewards</td>
			<td>Description here</td>
			<td>Voucher Code #</td>
			<td>14</td>
			<td>Expired</td>
			<td>Actions</td>
		</tr>
		
		<tr data-result_num=2>
			<td>1</td>
			<td>2014-04-25 11:11:56</td>
			<td>Basma Rewards</td>
			<td>Description here</td>
			<td>Voucher Code #</td>
			<td>14</td>
			<td>Expired</td>
			<td>Actions</td>
		</tr>
		
		<tr data-result_num=3>
			<td>1</td>
			<td>2014-04-25 11:11:56</td>
			<td>Basma Rewards</td>
			<td>Description here</td>
			<td>Voucher Code #</td>
			<td>14</td>
			<td>Expired</td>
			<td>Actions</td>
		</tr>
		
		<tr data-result_num=4>
			<td>1</td>
			<td>2014-04-25 11:11:56</td>
			<td>Basma Rewards</td>
			<td>Description here</td>
			<td>Voucher Code #</td>
			<td>14</td>
			<td>Expired</td>
			<td>Actions</td>
		</tr>
	</tbody>
	
</table>


<style>

table.pagination>tbody>tr{
	transition:opacity 0.3s;
}


table.pagination>tbody>tr[data-showing=false]{
	opacity:0;
	position:absolute;
	z-index:-1;
	color:rgba(0,0,0,0);
}

table.pagination>tfoot>tr>td{
	text-align:right;
}

.ajax_preloader[data-type=circular]{
	background-image:url('data:image/svg+xml;base64,PHN2ZyBpZD0ibG9hZGluZyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgMzIgMzIiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iIzAwYWZmMCI+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoMCAxNiAxNikiPgogICAgPGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ib3BhY2l0eSIgZnJvbT0iMSIgdG89Ii4xIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgYmVnaW49IjAiLz4KICA8L3BhdGg+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoNDUgMTYgMTYpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIGZyb209IjEiIHRvPSIuMSIgZHVyPSIxcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGJlZ2luPSIwLjEyNXMiLz4KICA8L3BhdGg+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoOTAgMTYgMTYpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIGZyb209IjEiIHRvPSIuMSIgZHVyPSIxcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGJlZ2luPSIwLjI1cyIvPgogIDwvcGF0aD4KICA8cGF0aCBvcGFjaXR5PSIuMSIgZD0iTTE0IDAgSDE4IFY4IEgxNCB6IiB0cmFuc2Zvcm09InJvdGF0ZSgxMzUgMTYgMTYpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIGZyb209IjEiIHRvPSIuMSIgZHVyPSIxcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGJlZ2luPSIwLjM3NXMiLz4KICA8L3BhdGg+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoMTgwIDE2IDE2KSI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiBmcm9tPSIxIiB0bz0iLjEiIGR1cj0iMXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBiZWdpbj0iMC41cyIvPgogIDwvcGF0aD4KICA8cGF0aCBvcGFjaXR5PSIuMSIgZD0iTTE0IDAgSDE4IFY4IEgxNCB6IiB0cmFuc2Zvcm09InJvdGF0ZSgyMjUgMTYgMTYpIj4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIGZyb209IjEiIHRvPSIuMSIgZHVyPSIxcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGJlZ2luPSIwLjY3NXMiLz4KICA8L3BhdGg+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoMjcwIDE2IDE2KSI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiBmcm9tPSIxIiB0bz0iLjEiIGR1cj0iMXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBiZWdpbj0iMC43NXMiLz4KICA8L3BhdGg+CiAgPHBhdGggb3BhY2l0eT0iLjEiIGQ9Ik0xNCAwIEgxOCBWOCBIMTQgeiIgdHJhbnNmb3JtPSJyb3RhdGUoMzE1IDE2IDE2KSI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiBmcm9tPSIxIiB0bz0iLjEiIGR1cj0iMXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBiZWdpbj0iMC44NzVzIi8+CiAgPC9wYXRoPgo8L3N2Zz4K');
	min-height:50px;
	min-width:50px;
	background-size:contain;
	background-position:center;
	background-repeat:no-repeat;
}

tbody>.ajax_preloader{
	display:table-cell;
	height:50px;
}

</style>

<script>

	document.addEventListener("DOMContentLoaded",function(){
	
		var tables = document.querySelectorAll("table[data-total_results]:not([data-total_results=''])");
		for(var i=0; i<tables.length; i++){
		
			var table = tables[i];
		
			table.update_footer 	= function(){
				
				this.tfoot 							= this.tfoot || this.appendChild(document.createElement("tfoot"));
				this.tfoot.rows[0]				= this.tfoot.rows[0] || this.tfoot.insertRow();
				this.tfoot.rows[0].cells[0]	= this.tfoot.rows[0].cells[0] || this.tfoot.rows[0].insertCell();
				this.tfoot.rows[0].cells[0].innerHTML = "";
				this.tfoot.rows[0].cells[0].setAttribute("colspan",this.tHead.rows[0].cells.length);
				
				this.total_pages = Math.ceil(this.total_results / this.results_per_page);
				
				if(this.total_pages > 2){
					var button 		= this.tfoot.rows[0].cells[0].appendChild(document.createElement("input"));
					button.type 	= "button";
					button.value 	= "<<";
					button.addEventListener("click",function(){table.update_scope({page:1});},false);
				}
				
				var button 		= this.tfoot.rows[0].cells[0].appendChild(document.createElement("input"));
				button.type 	= "button";
				button.value 	= "<";
				button.addEventListener("click",function(){table.update_scope({page:table.page-1});},false);

				
				for(var j=0; j<this.total_pages; j++){
					var button 		= this.tfoot.rows[0].cells[0].appendChild(document.createElement("input"));
					button.type 	= "button";
					button.value 	= j+1;
					button.addEventListener("click",function(){table.update_scope({page:this.value});},false);
				}
				
				var button 		= this.tfoot.rows[0].cells[0].appendChild(document.createElement("input"));
				button.type 	= "button";
				button.value 	= ">";
				button.addEventListener("click",function(){table.update_scope({page:table.page+1});},false);
				
				if(this.total_pages > 2){
					var button 		= this.tfoot.rows[0].cells[0].appendChild(document.createElement("input"));
					button.type 	= "button";
					button.value 	= ">>";
					button.addEventListener("click",function(){table.update_scope({page:table.total_pages});},false);
				}
				
			};
			
			table.capture_results = function(){
				this.results = new Array();
				
				var results = this.querySelectorAll("tbody>tr");
				for(var j=0; j<results.length; j++){
					var result = new Object();
					result.element = results[j];
					result.result_num = parseInt(results[j].dataset.result_num);
					this.results.push(result);
				}
			};
			
			table.update_scope 	= function(param){
				
				table.capture_results();
				
				param 					= (typeof param !== "object") ? {} : param;
				
				this.page			 	= param.page || this.page || 1;
				this.page 				= this.page > this.total_pages ? this.total_pages : this.page;
				
				var scope_start		= ((this.page-1)*this.results_per_page)+1;
				var scope_end 			= this.page*this.results_per_page;
				scope_end 				= (scope_end > this.total_results) ? this.total_results : scope_end;
				
				var missing_results = new Array();
				for(var j=scope_start-1; j<scope_end; j++){
					missing_results.push(j+1);
				}
				
				for(var j in this.results){
					var index = missing_results.indexOf(this.results[j].result_num);
					if(index != -1){
						missing_results.splice(index,1);
						this.results[j].element.dataset.showing="true";
					}
					else{
						this.results[j].element.dataset.showing="false";
					}
				}
				
				if(missing_results.length > 0){
					var ajax_url = "";
					for(var j in missing_results){
						ajax_url += "&global[fields][result_numbers][]="+missing_results[j];
					}
					
					//table.fetch_missing_rows(missing_results);
					ajax_table(table.tBodies[0],table.url+ajax_url,"50px",table.update_scope);
					
				}
				
				this.update_footer();
				
			};
			
			table.total_results 			= table.dataset.total_results;
			table.results_per_page 		= parseInt(table.dataset.results_per_page) || table.tBodies[0].querySelectorAll("tr").length;
			table.page 		= 1;
			table.total_pages				= Math.ceil(table.total_results / table.results_per_page);
			table.url						= table.dataset.url;
			
			//reset dataset
			for(var j in table.dataset){
				table.removeAttribute("data-"+j);
			}
			
			table.update_scope();
		}
	
	},false);
	
	function ajax_table(tbody,url,loader_size,callback){
	
		if(tbody.tagName != "TBODY"){
			console.error("ajaxTable needs a tbody as its first parameter");
			return;
		}
		
		var apr = tbody.insertRow();
		var aprc = apr.insertCell();
		aprc.style.textAlign = "center";
		aprc.setAttribute("colspan",tbody.parentNode.tHead.rows[0].cells.length);
		aprc.innerHTML = get_ajax_preloader(loader_size);
		
		
		if (url){
			$.ajax({
				url: url+"&global[ajax]=true",
				type: "POST",
				processData: false,
				contentType: false,
				success: function(data){
					tbody.removeChild(apr);
					
					var temp = document.createElement("table");
					temp.innerHTML = data;
					var rows = temp.querySelectorAll("tr");
					
					for(var i=0; i<rows.length; i++){
						tbody.appendChild(rows[i]);
					}
					
					tbody.parentNode.capture_results();
				
				}
			});
		}else{
			console.error("ajax_table(): no URL specified.");
		}
		
	}
</script>
